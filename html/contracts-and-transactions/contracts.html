

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>合约 &mdash; 以太坊Homestead文档 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
    <link rel="top" title="以太坊Homestead文档 0.1 documentation" href="../index.html"/>
        <link rel="up" title="合约和交易" href="index.html"/>
        <link rel="next" title="访问合约和交易" href="accessing-contracts-and-transactions.html"/>
        <link rel="prev" title="账户类型、气和交易" href="account-types-gas-and-transactions.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> 以太坊Homestead文档
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">引言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ethereum-clients/index.html">以太坊客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connecting-to-clients/index.html">连接到以太坊客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../account-management.html">账户管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ether.html">以太币</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/index.html">以太坊网络</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mining.html">挖矿</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">合约和交易</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="account-types-gas-and-transactions.html">账户类型、气和交易</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">合约</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">什么是合约？</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ethereum-high-level-languages">以太坊高级语言</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">Solidity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#serpent">Serpent</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">LLL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mutan">Mutan（不推荐）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">书写一个合约</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">编译一个合约</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#gethsolidity">在Geth中设置Solidity编译器</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compile-a-simple-contract">编译一个简单的合约</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id14">创建并发布一个合约</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interacting-with-a-contract">与一个合约进行交互</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">合约元数据</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id19">测试合约和交易</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="accessing-contracts-and-transactions.html">访问合约和交易</a></li>
<li class="toctree-l2"><a class="reference internal" href="mix.html">Mix</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer-tools.html">Dapps</a></li>
<li class="toctree-l2"><a class="reference internal" href="developer-tools.html#id3">开发工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="ethereum-tests/index.html">Ethereum Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="web3-base-layer-services.html">Web3基础层服务</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../frequently-asked-questions/frequently-asked-questions.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">Homestead文档计划</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">以太坊Homestead文档</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">合约和交易</a> &raquo;</li>
      
    <li>合约</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/contracts-and-transactions/contracts.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="contracts">
<span id="id1"></span><h1>合约<a class="headerlink" href="#contracts" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>什么是合约？<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>一个合约是一个在以太坊区块链上的某个特定地址存在的代码（它的功能）和数据（它的状态）的集合。合约账户可以进行图灵完备的运算，并且可以在账户间发送消息。合约以一个叫做以太坊虚拟机字节码的以太坊所特定的二进制格式保存在区块链上。</p>
<p>合约一般是由某种高级语言，比如 <a class="reference external" href="https://solidity.readthedocs.org/en/latest/">Solidity</a> 写成，然后被编译为字节码上传到区块链上的。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">其他语言也是存在的，尤其是Serpent和LLL，关于它们的介绍可以在 <a class="reference internal" href="#ethereum-high-level-languages"><span>以太坊高级语言</span></a> 找到。</p>
</div>
<p><a class="reference internal" href="developer-tools.html#ide-or-development-framework"><span>Dapp开发资源</span></a> 列出了集成开发环境和开发工具可以帮助你使用这些语言进行开发和测试的支持，并提供了一些其他特性。</p>
</div>
<div class="section" id="ethereum-high-level-languages">
<span id="id3"></span><h2>以太坊高级语言<a class="headerlink" href="#ethereum-high-level-languages" title="Permalink to this headline">¶</a></h2>
<p>以以太坊特定的二进制格式（EVM字节码）在区块链上存在的合约是由以太坊虚拟机（EVM）执行的。然而合约一般是由高级语言写成，再编译成为字节码发布到区块链上的。</p>
<p>下边是一些开发者可以用来书写以太坊智能合约的几种高级语言。</p>
<div class="section" id="id4">
<h3>Solidity<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Solidity是一种类似于Javascript的语言，可以用来开发合约并编译为EVM字节码。它也是以太坊开发中最受欢迎的标志性语言。</p>
<ul class="simple">
<li><a class="reference external" href="http://solidity.readthedocs.org/en/latest/">Solidity Documentation</a> - Solidity is the flagship Ethereum high level language that is used to write contracts.</li>
<li><a class="reference external" href="http://ethereum.github.io/browser-solidity/">Solidity online realtime compiler</a></li>
<li><a class="reference external" href="https://github.com/ethereum/wiki/wiki/Standardized_Contract_APIs">Standardized Contract APIs</a></li>
<li><a class="reference external" href="https://github.com/ethereum/wiki/wiki/Useful-Ðapp-Patterns">Useful Ðapp Patterns</a> - Code snippets which are useful for Ðapp development.</li>
</ul>
</div>
<div class="section" id="serpent">
<h3>Serpent<a class="headerlink" href="#serpent" title="Permalink to this headline">¶</a></h3>
<p>Serpent是一个类似于Python的语言，可以用来开发合约并编译为EVM字节码。它最求最大化的简洁，融合了很多低级语言的优点，采用简单易用的编程风格。同时添加了为合约编程定制的一些特性。Serpent是用 <span class="target" id="lll">LLL</span> 编译的。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ethereum/wiki/wiki/Serpent">Serpent on the ethereum wiki</a></li>
<li><a class="reference external" href="https://github.com/ethereum/serpent">Serpent EVM compiler</a></li>
</ul>
</div>
<div class="section" id="id5">
<h3>LLL<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/ethereum/libethereum/tree/develop/liblll">Lisp Like Language (LLL)</a> 是一种类似于汇编语言的低级语言，极其简单和抽象化，本质上就是直接在EVM上书写代码的极小包装。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ethereum/libethereum/tree/develop/liblll">LIBLLL in GitHub</a></li>
<li><a class="reference external" href="https://www.reddit.com/r/ethereum/comments/3secu1/anyone_have_a_copy_of_the_old_lll_tutorials/">Examples of LLL</a></li>
</ul>
</div>
<div class="section" id="mutan">
<h3>Mutan（不推荐）<a class="headerlink" href="#mutan" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/obscuren/mutan">Mutan</a> 是一个由Jeffrey Wilcke设计开发的，静态类型的，类似于C语言的开发语言。现在已经不再维护。</p>
</div>
</div>
<div class="section" id="id7">
<h2>书写一个合约<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>没有哪个语言能躲开写一个Hello World程序。在以太坊环境中，Solidity没有一个明确的方法可以“输出”字符串。最相近的方式就是使用 <em>log event</em> 来将一个字符串放到区块链上：</p>
<div class="code js highlight-python"><div class="highlight"><pre>contract HelloWorld {
        event Print(string out);
        function() { Print(&quot;Hello, World!&quot;); }
}
</pre></div>
</div>
<p>这个合约会在区块链上创建一个日志项，在它每次被执行时在其中打印一个“Hello World!”。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="https://solidity.readthedocs.org/en/latest/">Solidity docs</a> 有更多样例和指引来书写Solidity代码。</p>
</div>
</div>
<div class="section" id="id8">
<h2>编译一个合约<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>编译Solidity合约可以通过以下几种途径完成。</p>
<ul class="simple">
<li>在命令行使用 <code class="docutils literal"><span class="pre">solc</span></code> 编译器。</li>
<li>在 <code class="docutils literal"><span class="pre">geth</span></code> or <code class="docutils literal"><span class="pre">eth</span></code> 提供的javascript控制台使用 <code class="docutils literal"><span class="pre">web3.eth.compile.solidity</span></code> （这也需要安装 <code class="docutils literal"><span class="pre">solc</span></code> 编译器）。</li>
<li>使用 <a class="reference external" href="https://ethereum.github.io/browser-solidity/">Solidity的在线实时编译器</a>.</li>
<li>使用 <a class="reference external" href="https://github.com/SilentCicero/meteor-dapp-cosmo">Meteor dapp Cosmo来创建Solidity合约</a>.</li>
<li>使用 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/Mix:-The-DApp-IDE">Mix IDE</a>.</li>
<li>使用 <a class="reference external" href="https://github.com/ethereum/mist/releases">以太坊钱包</a>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">更多关于使用solc编译Solidity合约的信息可以在 <a class="reference external" href="https://solidity.readthedocs.org/en/latest/frequently-asked-questions.html#how-do-i-compile-contracts">这里</a> 找到。</p>
</div>
<div class="section" id="gethsolidity">
<h3>在Geth中设置Solidity编译器<a class="headerlink" href="#gethsolidity" title="Permalink to this headline">¶</a></h3>
<p>如果你已经启动 <code class="docutils literal"><span class="pre">geth</span></code> 你可以检查哪种编译器是可用的。</p>
<div class="code bash highlight-python"><div class="highlight"><pre>&gt; web3.eth.getCompilers();
[&quot;lll&quot;, &quot;solidity&quot;, &quot;serpent&quot;]
</pre></div>
</div>
<p>这个命令会返回一个数组指出当前可用的编译器。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">solc</span></code> 编译器是随着 <code class="docutils literal"><span class="pre">cpp-ethereum</span></code> 一起安装的，或者你可以 <a class="reference external" href="https://github.com/ethereum/go-ethereum/wiki/Building-Ethereum">自己构建它</a></p>
</div>
<p>如果你的 <code class="docutils literal"><span class="pre">solc</span></code> 程序在一个不标准的位置，你可以使用 <code class="docutils literal"><span class="pre">--solc</span></code> 参数来指定其执行目录。</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ geth --solc /usr/local/bin/solc
</pre></div>
</div>
<p>或者，你可以在控制台运行时设置这个选项：</p>
<div class="code bash highlight-python"><div class="highlight"><pre>&gt; admin.setSolc(&quot;/usr/local/bin/solc&quot;)
solc, the solidity compiler commandline interface
Version: 0.2.2-02bb315d/.-Darwin/appleclang/JIT linked to libethereum-1.2.0-8007cef0/.-Darwin/appleclang/JIT
path: /usr/local/bin/solc
</pre></div>
</div>
</div>
<div class="section" id="compile-a-simple-contract">
<span id="id13"></span><h3>编译一个简单的合约<a class="headerlink" href="#compile-a-simple-contract" title="Permalink to this headline">¶</a></h3>
<p>让我们编译一个简单的合约代码：</p>
<div class="code bash highlight-python"><div class="highlight"><pre>&gt; source = &quot;contract test { function multiply(uint a) returns(uint d) { return a * 7; } }&quot;
</pre></div>
</div>
<p>这个合约提供了一个方法 <strong>multiply</strong> ，可以用一个正整数 <code class="docutils literal"><span class="pre">a</span></code> 做参数，返回 <code class="docutils literal"><span class="pre">a</span> <span class="pre">*</span> <span class="pre">7</span></code> 。</p>
<p>你可以使用 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethcompilesolidity">eth.compile.solidity()</a> 在 <code class="docutils literal"><span class="pre">geth</span></code> 的JS控制台编译Solidity代码：</p>
<div class="code bash highlight-python"><div class="highlight"><pre>&gt; contract = eth.compile.solidity(source).test
{
  code: &#39;605280600c6000396000f3006000357c010000000000000000000000000000000000000000000000000000000090048063c6888fa114602e57005b60376004356041565b8060005260206000f35b6000600782029050604d565b91905056&#39;,
  info: {
    language: &#39;Solidity&#39;,
    languageVersion: &#39;0&#39;,
    compilerVersion: &#39;0.9.13&#39;,
    abiDefinition: [{
      constant: false,
      inputs: [{
        name: &#39;a&#39;,
        type: &#39;uint256&#39;
      } ],
      name: &#39;multiply&#39;,
      outputs: [{
        name: &#39;d&#39;,
        type: &#39;uint256&#39;
      } ],
      type: &#39;function&#39;
    } ],
    userDoc: {
      methods: {
      }
    },
    developerDoc: {
      methods: {
      }
    },
    source: &#39;contract test { function multiply(uint a) returns(uint d) { return a * 7; } }&#39;
  }
}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">也可以通过 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/JSON-RPC">RPC</a> 使用编译器，或者通过RPC/IPC的方式，基于 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethcompilesolidity">web3.js</a> 来是任意基于浏览器的Ðapp连接到 <code class="docutils literal"><span class="pre">geth</span></code> 来使用编译器。</p>
</div>
<p>下面的样例会演示通过JSON-RPC来访问 <code class="docutils literal"><span class="pre">geth</span></code> 以使用编译器。</p>
<div class="code bash highlight-python"><div class="highlight"><pre>$ geth --datadir ~/eth/ --loglevel 6 --logtostderr=true --rpc --rpcport 8100 --rpccorsdomain &#39;*&#39; --mine console  2&gt;&gt; ~/eth/eth.log
$ curl -X POST --data &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_compileSolidity&quot;,&quot;params&quot;:[&quot;contract test { function multiply(uint a) returns(uint d) { return a * 7; } }&quot;],&quot;id&quot;:1}&#39; http://127.0.0.1:8100
</pre></div>
</div>
<p>编译器输出的代码中的每个合约对象代表了一个单独的合约。 <code class="docutils literal"><span class="pre">eth.compile.solidity</span></code> 实际的返回值是一个合约名字和合约对象的映射对。由于我们的合约名字是 <code class="docutils literal"><span class="pre">test</span></code> ， <code class="docutils literal"><span class="pre">eth.compile.solidity(source).test</span></code> 会返回给你test合约的合约对象，包含以下字段：</p>
<dl class="glossary docutils">
<dt id="term-code"><code class="docutils literal"><span class="pre">code</span></code></dt>
<dd>编译好的EVM字节码</dd>
<dt id="term-info"><code class="docutils literal"><span class="pre">info</span></code></dt>
<dd>编译器输出的额外的元数据</dd>
<dt id="term-source"><code class="docutils literal"><span class="pre">source</span></code></dt>
<dd>源代码</dd>
<dt id="term-language"><code class="docutils literal"><span class="pre">language</span></code></dt>
<dd>合约的语言（Solidity、Serpent或LLL）</dd>
<dt id="term-languageversion"><code class="docutils literal"><span class="pre">languageVersion</span></code></dt>
<dd>合约语言的版本</dd>
<dt id="term-compilerversion"><code class="docutils literal"><span class="pre">compilerVersion</span></code></dt>
<dd>编译这个合约的编译器的版本</dd>
<dt id="term-abidefinition"><code class="docutils literal"><span class="pre">abiDefinition</span></code></dt>
<dd><a class="reference external" href="https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI">Application Binary Interface Definition（应用程序二进制接口定义）</a></dd>
<dt id="term-userdoc"><code class="docutils literal"><span class="pre">userDoc</span></code></dt>
<dd>用户的 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/Ethereum-Natural-Specification-Format">NatSpec Doc</a> 。</dd>
<dt id="term-developerdoc"><code class="docutils literal"><span class="pre">developerDoc</span></code></dt>
<dd>开发者的 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/Ethereum-Natural-Specification-Format">NatSpec Doc</a> 。</dd>
</dl>
<p>编译器输出内容的结构化（分为 <code class="docutils literal"><span class="pre">code</span></code> 和 <code class="docutils literal"><span class="pre">info</span></code> ）反映了两种截然不同的 <strong>发布路径</strong> 。一套EVM代码由一个创建合约的交易发送到区块链上，而其余（信息）则会适当的保存在去中心化的云端，作为在区块链上的可校验元数据使代码得以完整。</p>
<p>如果你的源码包含多个合约，输出则会包含每个合约的单独数据项，可以用合约名字作为属性名获得对应的合约信息对象。你可以通过检查当前的GlobalRegistrar代码来尝试。</p>
<div class="code js highlight-python"><div class="highlight"><pre><span class="n">contracts</span> <span class="o">=</span> <span class="n">eth</span><span class="o">.</span><span class="n">compile</span><span class="o">.</span><span class="n">solidity</span><span class="p">(</span><span class="n">globalRegistrarSrc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h2>创建并发布一个合约<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
<p>在你开始这节之前，请确保你有一个已解锁的账户并有一些资金。</p>
<p>你可以用前一章节中的EVM代码作为数据，通过 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethsendtransaction">发送一个交易</a> 到一个空的地址来在区块链上创建一个合约。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">使用 <a class="reference external" href="https://ethereum.github.io/browser-solidity/">Solidity的在线实时编译器</a> 或者 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/Mix:-The-DApp-IDE">Mix IDE</a> 可以很容易地实现。</p>
</div>
<div class="code js highlight-python"><div class="highlight"><pre>var primaryAddress = eth.accounts[0]
var abi = [{ constant: false, inputs: { name: &#39;a&#39;, type: &#39;uint256&#39; } }]
var MyContract = eth.contract(abi)
var contract = MyContract.new(arg1, arg2, ..., {from: primaryAddress, data: evmByteCodeFromPreviousSection})
</pre></div>
</div>
<p>所有二进制数据都会被序列化为十六进制格式。十六进制字符串通常会以固定前缀 <code class="docutils literal"><span class="pre">0x</span></code> 开头。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">注意， <code class="docutils literal"><span class="pre">arg1,</span> <span class="pre">arg2,</span> <span class="pre">...</span></code> 是合约构造器的参数，可以接受任意数据。如果你的合约不需要构造参数，就可以省略它们。</p>
</div>
<p>值得指出的是，这个步骤需要你为执行付费。一旦你的交易进入某个区块，你的账户余额（就是你作为发送方在 <code class="docutils literal"><span class="pre">from</span></code> 指定的账户）会根据EVM中气的用量的规则相应减少。一段时间之后，你的交易可能会出现在某个区块中，即它所带来的状态的共识得到确认。你的合约就在区块链上生效了。</p>
<p>用异步方式做同样的事，应该是像这样：</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">MyContract</span><span class="p">.</span><span class="k">new</span><span class="p">([</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">,</span> <span class="p">...,]{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">primaryAccount</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">evmCode</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">contract</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="interacting-with-a-contract">
<span id="id17"></span><h2>与一个合约进行交互<a class="headerlink" href="#interacting-with-a-contract" title="Permalink to this headline">¶</a></h2>
<p>与合约的交互一般可以通过一个类似 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethcontract">eth.contract()</a> 的抽象层函数来实现，它会返回一个javascript对象，带有目标合约的所有可调用函数。</p>
<p>描述一个合约的有效函数的标准方式是 <a class="reference external" href="https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI">ABI definition</a> 。这个对象是一个数组，描述了每个有效的合约函数的调用方法和返回值。</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Multiply7</span> <span class="o">=</span> <span class="nx">eth</span><span class="p">.</span><span class="nx">contract</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">abiDefinition</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">myMultiply7</span> <span class="o">=</span> <span class="nx">Multiply7</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span><span class="nx">address</span><span class="p">);</span>
</pre></div>
</div>
<p>现在所有在ABI中说明的函数调用都在合约实例上可用了，你可以选择两种调用方式之一在合约实例上实际调用。</p>
<div class="highlight-js"><div class="highlight"><pre><span class="o">&gt;</span> <span class="nx">myMultiply7</span><span class="p">.</span><span class="nx">multiply</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="nx">from</span><span class="o">:</span> <span class="nx">address</span><span class="p">})</span>
<span class="s2">&quot;0x12345&quot;</span>
<span class="o">&gt;</span> <span class="nx">myMultiply7</span><span class="p">.</span><span class="nx">multiply</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="mi">21</span>
</pre></div>
</div>
<p>当使用 <code class="docutils literal"><span class="pre">sendTransaction</span></code> 这个函数来通过发送交易来调用合约函数时，它会消耗以太币来执行发送，并被永久的记录到区块链上。这种方式调用的返回值是交易的哈希值。</p>
<p>当使用 <code class="docutils literal"><span class="pre">call</span></code> 这个函数来调用合约函数时，执行实在本地EVM中进行的，返回值将是合约函数的实际返回值。这种方式的调用不会被记录到区块链上，但也不能更改合约的内部状态。这种方式也就是一种 <strong>不变的</strong> 函数调用，当然也不会花费以太币。</p>
<p>你应该在只关心返回值的时候使用 <code class="docutils literal"><span class="pre">call</span></code> ，而在只关心合约状态的 <em>边界效应（side effects，即副作用、额外的影响，译者注）</em> 时使用 <code class="docutils literal"><span class="pre">sendTransaction</span></code> 。</p>
<p>在以上的例子中并没有边界效应，所以 <code class="docutils literal"><span class="pre">sendTransaction</span></code> 仅仅消耗了气，增加了宇宙里的总熵。</p>
</div>
<div class="section" id="id18">
<h2>合约元数据<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h2>
<p>在上面的章节里我们解释了你如何创建在区块链上创建一个合约。现在我们来看一下编译器余下的输出， <strong>合约元数据</strong> 或者叫合约信息。</p>
<p>当与一个不是你自己创建的合约进行交互的时候，你也许会希望看到它的文档或者源码。合约作者被鼓励来在区块链上注册这样的信息或者通过一个类似于 <a class="reference external" href="https://www.etherchain.org/contracts">EtherChain</a> 的第三方服务来进行发布。 <code class="docutils literal"><span class="pre">admin</span></code> API提供了方便的方法来获取选择了注册的任何合约的具体信息。</p>
<div class="code js highlight-python"><div class="highlight"><pre>// get the contract info for contract address to do manual verification
var info = admin.getContractInfo(address) // lookup, fetch, decode
var source = info.source;
var abiDef = info.abiDefinition
</pre></div>
</div>
<p>确保这种方法可以运作的底层机制是：</p>
<ul class="simple">
<li>合约信息被上传到某处，由一个 <em>URI</em> 标示为可以公开访问</li>
<li>任何仅知道合约地址的人都可以知道这个 <em>URI</em></li>
</ul>
<p>这些需求是通过两步区块链注册实现的。第一步注册是通过一个叫做 <code class="docutils literal"><span class="pre">HashReg</span></code> 的合约对要做注册的合约代码进行内容哈希。第二步则是用第一步中生成的内容哈希，通过 <code class="docutils literal"><span class="pre">UrlHint</span></code> 这个合约来注册一个URL。这种 <a class="reference external" href="https://github.com/ethereum/go-ethereum/blob/develop/common/registrar/contracts.go">合约注册机制</a> 是Frontier版本的一部分，被拿到了Homestead版本中。</p>
<p>基于这种方案，我们就可以通过已知的合约地址来查询url，从而获得实际的合约元数据信息包。</p>
<p>至此我们可以小结下合约创建的步骤：</p>
<ul class="simple">
<li>1、把合约本身发布到区块链上</li>
<li>2、取得合约信息json文件</li>
<li>3、把合约信息json文件发布到你选择的url上</li>
<li>4、注册 代码哈希 -&gt; 内容哈希 -&gt; url</li>
</ul>
<p>JS API提供了助手使这个过程非常简单。调用 <code class="docutils literal"><span class="pre">admin.register</span></code> 可以从合约取得其合约信息，把这些json内容写入到一个文件，计算这个文件的内容哈希，最后用合约的代码哈希来注册内容哈希。当你把这个内容文件发布到某个url之后，你可以使用 <code class="docutils literal"><span class="pre">admin.registerUrl</span></code> 来用你的内容哈希把url注册到区块链上。（注意，如果以固定内容地址模式来存储文档，那就不需要再使用url-hint这个合约了。）</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">source</span> <span class="o">=</span> <span class="s2">&quot;contract test { function multiply(uint a) returns(uint d) { return a * 7; } }&quot;</span>
<span class="c1">// compile with solc</span>
<span class="nx">contract</span> <span class="o">=</span> <span class="nx">eth</span><span class="p">.</span><span class="nx">compile</span><span class="p">.</span><span class="nx">solidity</span><span class="p">(</span><span class="nx">source</span><span class="p">).</span><span class="nx">test</span>
<span class="c1">// create contract object</span>
<span class="kd">var</span> <span class="nx">MyContract</span> <span class="o">=</span> <span class="nx">eth</span><span class="p">.</span><span class="nx">contract</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">abiDefinition</span><span class="p">)</span>
<span class="c1">// extracts info from contract, save the json serialisation in the given file,</span>
<span class="nx">contenthash</span> <span class="o">=</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">saveInfo</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">info</span><span class="p">,</span> <span class="s2">&quot;~/dapps/shared/contracts/test/info.json&quot;</span><span class="p">)</span>
<span class="c1">// send off the contract to the blockchain</span>
<span class="nx">MyContract</span><span class="p">.</span><span class="k">new</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">primaryAccount</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">code</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">contract</span><span class="p">){</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// calculates the content hash and registers it with the code hash in `HashReg`</span>
    <span class="c1">// it uses address to send the transaction.</span>
    <span class="c1">// returns the content hash that we use to register a url</span>
    <span class="nx">admin</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">primaryAccount</span><span class="p">,</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="nx">contenthash</span><span class="p">)</span>
    <span class="c1">// here you deploy ~/dapps/shared/contracts/test/info.json to a url</span>
    <span class="nx">admin</span><span class="p">.</span><span class="nx">registerUrl</span><span class="p">(</span><span class="nx">primaryAccount</span><span class="p">,</span> <span class="nx">hash</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="id19">
<h2>测试合约和交易<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h2>
<p>你一般需要用一些底层的策略来测试、调试合约和交易。这节会介绍一些调试工具。为了不涉及真实共识逻辑来测试合约和交易，最好的方式时使用私有区块链。这可以通过设置一个特殊的网络id（比如选一个特殊的整数）并禁止掉其他节点来做到。推荐的方式是使用独立的数据目录和网络端口，以免因为误操作影响到你正在使用的区块链网络（如果你使用默认设置的话）。推荐你使用带分析的最高日志等级的VM debug模式启动 <code class="docutils literal"><span class="pre">geth</span></code> 。</p>
<div class="code bash highlight-python"><div class="highlight"><pre>geth --datadir ~/dapps/testing/00/ --port 30310 --rpcport 8110 --networkid 4567890 --nodiscover --maxpeers 0 --vmdebug --verbosity 6 --pprof --pprofport 6110 console 2&gt;&gt; ~/dapp/testint/00/00.log
</pre></div>
</div>
<p>在提交交易之前，你需要先设置好你的私有测试链。请参考 <a class="reference internal" href="../network/test-networks.html#test-networks"><span>测试网络</span></a> 。</p>
<div class="code js highlight-python"><div class="highlight"><pre>// create account. will prompt for password
personal.newAccount();
// name your primary account, will often use it
primary = eth.accounts[0];
// check your balance (denominated in ether)
balance = web3.fromWei(eth.getBalance(primary), &quot;ether&quot;);
</pre></div>
</div>
<div class="code js highlight-python"><div class="highlight"><pre>// assume an existing unlocked primary account
primary = eth.accounts[0];

// mine 10 blocks to generate ether

// starting miner
miner.start(4);
// sleep for 10 blocks (this can take quite some time).
admin.sleepBlocks(10);
// then stop mining (just not to burn heat in vain)
miner.stop();
balance = web3.fromWei(eth.getBalance(primary), &quot;ether&quot;);
</pre></div>
</div>
<p>创建交易之后，你可以用以下命令强制处理它们：</p>
<div class="code js highlight-python"><div class="highlight"><pre><span class="n">miner</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">admin</span><span class="o">.</span><span class="n">sleepBlocks</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">miner</span><span class="o">.</span><span class="n">stop</span><span class="p">();</span>
</pre></div>
</div>
<p>你可以检查待处理的交易：</p>
<div class="code js highlight-python"><div class="highlight"><pre>// shows transaction pool
txpool.status
// number of pending txs
eth.getBlockTransactionCount(&quot;pending&quot;);
// print all pending txs
eth.getBlock(&quot;pending&quot;, true).transactions
</pre></div>
</div>
<p>如果你提交了创建合约的交易，你可以检查合约代码是否已经被加入当前的区块链：</p>
<div class="code js highlight-python"><div class="highlight"><pre>txhash = eth.sendTansaction({from:primary, data: code})
//... mining
contractaddress = eth.getTransactionReceipt(txhash);
eth.getCode(contractaddress)
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="accessing-contracts-and-transactions.html" class="btn btn-neutral float-right" title="访问合约和交易" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="account-types-gas-and-transactions.html" class="btn btn-neutral" title="账户类型、气和交易" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Ethereum community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>